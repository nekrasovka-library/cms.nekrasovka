<div class="afisha-container">
  <div class="afisha-header">
    <span>Афиша</span>
    <a href="//nekrasovka.ru/afisha">
      <span>Все события</span>
      <svg
        width="16"
        height="8"
        viewBox="0 0 16 8"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M15.3536 4.35355C15.5488 4.15829 15.5488 3.84171 15.3536 3.64645L12.1716 0.464466C11.9763 0.269204 11.6597 0.269204 11.4645 0.464466C11.2692 0.659728 11.2692 0.976311 11.4645 1.17157L14.2929 4L11.4645 6.82843C11.2692 7.02369 11.2692 7.34027 11.4645 7.53553C11.6597 7.7308 11.9763 7.7308 12.1716 7.53553L15.3536 4.35355ZM0 4.5H15V3.5H0V4.5Z"
          fill="#346178"
        />
      </svg>
    </a>
  </div>
  <div class="afisha-main">
    <div
      class="afisha-button afisha-button-left"
      id="prevButton"
      style="display: none"
    >
      <svg
        width="40"
        height="40"
        viewBox="0 0 40 40"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <circle
          cx="20"
          cy="20"
          r="19"
          fill="#EDEEE9"
          stroke="#346178"
          stroke-width="2"
        />
        <path
          opacity="0.969"
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M15.8558 12.0055C16.1453 11.9874 16.4297 12.0141 16.7089 12.0855C19.4082 14.3403 22.0919 16.6153 24.7599 18.9102C25.4329 19.4701 25.5217 20.11 25.0265 20.8297C22.3251 23.1401 19.6236 25.4506 16.9222 27.761C16.5236 28.0119 16.0971 28.0653 15.6425 27.921C14.9817 27.4837 14.8306 26.9061 15.1893 26.1881C17.5719 24.1165 19.9623 22.0549 22.3606 20.0032C19.9972 17.9332 17.6245 15.8715 15.2426 13.8183C14.8711 13.0044 15.0755 12.4001 15.8558 12.0055Z"
          fill="#346178"
        />
      </svg>
    </div>
    <div
      class="afisha-button afisha-button-right"
      id="nextButton"
      style="display: none"
    >
      <svg
        width="40"
        height="40"
        viewBox="0 0 40 40"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <circle
          cx="20"
          cy="20"
          r="19"
          fill="#EDEEE9"
          stroke="#346178"
          stroke-width="2"
        />
        <path
          opacity="0.969"
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M15.8558 12.0055C16.1453 11.9874 16.4297 12.0141 16.7089 12.0855C19.4082 14.3403 22.0919 16.6153 24.7599 18.9102C25.4329 19.4701 25.5217 20.11 25.0265 20.8297C22.3251 23.1401 19.6236 25.4506 16.9222 27.761C16.5236 28.0119 16.0971 28.0653 15.6425 27.921C14.9817 27.4837 14.8306 26.9061 15.1893 26.1881C17.5719 24.1165 19.9623 22.0549 22.3606 20.0032C19.9972 17.9332 17.6245 15.8715 15.2426 13.8183C14.8711 13.0044 15.0755 12.4001 15.8558 12.0055Z"
          fill="#346178"
        />
      </svg>
    </div>
    <div class="events-container" id="eventsContainer"></div>
  </div>
</div>
<style>
  :root {
    /* Color palette */
    --primary-color: #346178;
    --error-color: #922d15;
    --error-text-color: #77777785;
    --overlay-opacity: 0.4;

    /* Spacing */
    --container-max-width: 1200px;
    --border-radius: 5px;
    --spacing-xs: 5px;
    --spacing-sm: 10px;
    --spacing-md: 15px;
    --spacing-lg: 20px;
    --spacing-xl: 25px;
    --spacing-xxl: 30px;
    --spacing-xxxl: 40px;

    /* Typography */
    --font-weight-normal: 400;
    --font-weight-medium: 500;

    /* Breakpoints */
    --breakpoint-mobile: 767px;
    --breakpoint-tablet: 768px;
    --breakpoint-desktop: 1239px;
    --breakpoint-large: 1240px;
  }

  /* Base container styles */
  .afisha-container {
    max-width: var(--container-max-width);
    margin: 0 auto;
  }

  .afisha-main {
    position: relative;
  }

  /* Header styles */
  .afisha-header {
    display: flex;
    justify-content: space-between;
  }

  .afisha-header span {
    color: var(--primary-color);
  }

  .afisha-header > span {
    font-weight: var(--font-weight-medium);
  }

  .afisha-header > a {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--primary-color);
  }

  .afisha-header > a svg {
    margin-left: var(--spacing-xs);
  }

  /* Events container */
  .events-container {
    display: flex;
    position: relative;
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 100%;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .events-container::-webkit-scrollbar {
    display: none;
  }

  /* Event card base styles */
  .event-card {
    display: flex;
    flex-direction: column;
    border-radius: var(--border-radius);
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
    position: relative;
    color: var(--primary-color);
    box-sizing: border-box;
  }

  .event-card a {
    text-decoration: none;
    color: inherit;
  }

  /* Event card error state */
  .event-card.error {
    position: relative;
  }

  .event-card.error::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: var(--overlay-opacity);
    border-radius: var(--border-radius);
    z-index: 1;
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
  }

  .event-card.error > * {
    position: relative;
    z-index: 2;
  }

  .error a,
  .error .datetime-header,
  .error .tags-section {
    color: var(--error-text-color);
  }

  .error .location-text {
    color: var(--error-color);
    font-size: 18px;
  }

  /* Content sections */
  .datetime-section {
    display: flex;
    flex-direction: column;
    row-gap: var(--spacing-xs);
  }

  .datetime-header {
    display: flex;
    justify-content: space-between;
  }

  .date-text {
    font-weight: var(--font-weight-medium);
  }

  .title-section {
    display: flex;
    flex-direction: column;
    row-gap: var(--spacing-xs);
    margin-top: var(--spacing-xl);
  }

  .event-title {
    font-style: normal;
    font-weight: var(--font-weight-medium);
  }

  .event-subtitle {
    font-style: normal;
    font-weight: var(--font-weight-normal);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .footer-section {
    margin-top: auto;
  }

  .price-tag {
    width: fit-content;
    padding: var(--spacing-sm);
    border: 1px solid var(--primary-color);
    border-radius: var(--border-radius);
    font-style: normal;
    font-weight: var(--font-weight-normal);
    font-size: 15px;
    line-height: 18px;
    margin-bottom: var(--spacing-md);
  }

  .series-text {
    font-style: normal;
    font-weight: var(--font-weight-normal);
    font-size: 14px;
    line-height: 17px;
    margin-bottom: var(--spacing-sm);
  }

  .tags-section {
    display: flex;
    justify-content: space-between;
    font-style: normal;
    font-weight: var(--font-weight-normal);
    line-height: 17px;
  }

  /* State styles */
  .error-message {
    text-align: center;
    padding: var(--spacing-xxxl);
    color: var(--error-color);
  }

  .skeleton-card {
    position: relative;
    overflow: hidden;
  }

  .skeleton-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: skeleton-loading 2s infinite;
  }

  .skeleton-card .skeleton-text {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
    color: transparent;
    filter: blur(1px);
    animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
  }

  @keyframes skeleton-loading {
    0% {
      left: -100%;
    }
    100% {
      left: 100%;
    }
  }

  @keyframes skeleton-pulse {
    0% {
      opacity: 0.6;
    }
    100% {
      opacity: 1;
    }
  }

  /* Large desktop styles */
  @media (min-width: 1239px) {
    .events-container {
      column-gap: var(--spacing-xxl);
    }

    .afisha-header {
      margin-bottom: var(--spacing-xxl);
    }
  }

  /* Medium desktop styles */
  @media (max-width: 1240px) {
    .afisha-header {
      margin-bottom: var(--spacing-lg);
    }
  }

  /* Tablet styles */
  @media (max-width: 1240px) and (min-width: 768px) {
    .event-card:first-child {
      margin-left: var(--spacing-lg);
    }

    .event-card:last-child {
      margin-right: var(--spacing-lg);
    }

    .events-container {
      column-gap: var(--spacing-lg);
    }

    .afisha-header {
      padding-left: var(--spacing-lg);
      padding-right: var(--spacing-lg);
    }
  }

  /* Desktop and tablet shared styles */
  @media (min-width: 768px) {
    .afisha-header > span {
      font-size: 24px;
    }

    .afisha-header > a span {
      font-size: 14px;
    }

    .afisha-button {
      position: absolute;
      top: calc(50% - 20px);
      z-index: 100;
      border-radius: 50%;
      cursor: pointer;
    }

    .afisha-button-left {
      left: -20px;
    }

    .afisha-button-right {
      right: -20px;
    }

    .afisha-button-left svg {
      transform: rotate(180deg);
    }

    .event-card {
      height: 400px;
      min-width: 380px;
      max-width: 380px;
      padding: var(--spacing-lg);
    }

    .event-title {
      font-size: 24px;
      line-height: 28px;
    }

    .event-subtitle {
      font-size: 21px;
      line-height: 25px;
    }

    .datetime-section {
      font-size: 18px;
    }

    .location-text {
      font-size: 14px;
    }

    .tags-section {
      font-size: 14px;
    }
  }

  /* Mobile styles */
  @media (max-width: 767px) {
    .afisha-header {
      padding-left: var(--spacing-md);
      padding-right: var(--spacing-md);
    }

    .afisha-header > span {
      font-size: 16px;
    }

    .afisha-header > a span {
      font-size: 12px;
    }

    .afisha-button {
      display: none;
    }

    .events-container {
      column-gap: var(--spacing-md);
    }

    .event-card {
      height: 248px;
      min-width: 248px;
      max-width: 248px;
      padding: var(--spacing-sm);
    }

    .event-card:first-child {
      margin-left: var(--spacing-md);
    }

    .event-card:last-child {
      margin-right: var(--spacing-md);
    }

    .event-title {
      font-size: 14px;
      line-height: 17px;
    }

    .event-subtitle {
      font-size: 12px;
      line-height: 14px;
    }

    .datetime-section {
      font-size: 14px;
    }

    .location-text {
      font-size: 12px;
    }

    .tags-section {
      font-size: 12px;
    }
  }
</style>
<script>
  // Константы
  const MONTHS = [
    "января",
    "февраля",
    "марта",
    "апреля",
    "мая",
    "июня",
    "июля",
    "августа",
    "сентября",
    "октября",
    "ноября",
    "декабря",
  ];

  const WEEKDAYS = [
    "воскресенье",
    "понедельник",
    "вторник",
    "среда",
    "четверг",
    "пятница",
    "суббота",
  ];

  const CONFIG = {
    API_URL: "https://api.electro.nekrasovka.ru/api/calendars",
    DEFAULT_TRACKS: 7,
    DEFAULT_GAP: 30,
    DESKTOP_BREAKPOINT: 1240,
    ITEMS_PER_PAGE: 3,
    RETRY_DELAY: 100,
    CANCELLED_EVENT_TEXT: "Отменено",
    CANCELLED_EVENT_MESSAGE: "Мероприятие отменено",
    ERROR_MESSAGE: "Ошибка загрузки событий",
    SKELETON_CARDS_COUNT: 3,
    LAZY_LOAD_THRESHOLD: 0.1, // Загружать когда 10% элемента видно
    IMAGE_LOAD_DELAY: 200, // Задержка между загрузкой изображений (мс)
  };

  class AfishaJS {
    constructor() {
      this.events = [];
      this.scrollIndex = 1;
      this.tracks = CONFIG.DEFAULT_TRACKS;
      this.gap = CONFIG.DEFAULT_GAP;
      this.windowWidth = window.innerWidth;
      this.imageLoadQueue = [];
      this.isLoadingImages = false;
      this.intersectionObserver = null;

      if (!this.initializeDOMElements()) {
        console.error("Не найдены необходимые элементы DOM для AfishaJS");
        return;
      }

      this.scrollAmount = this.eventsContainer.clientWidth + this.gap;
      this.init();
    }

    initializeDOMElements() {
      this.eventsContainer = document.getElementById("eventsContainer");
      this.prevButton = document.getElementById("prevButton");
      this.nextButton = document.getElementById("nextButton");

      return this.eventsContainer && this.prevButton && this.nextButton;
    }

    init() {
      this.initIntersectionObserver();
      this.renderSkeletonCards();
      this.fetchEvents();
      this.setupEventListeners();
      if (this.windowWidth > CONFIG.DESKTOP_BREAKPOINT) {
        this.preventScroll();
      }
    }

    initIntersectionObserver() {
      this.intersectionObserver = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    const card = entry.target;
                    const imageUrl = card.dataset.imageUrl;

                    if (imageUrl && !card.classList.contains("image-loaded")) {
                      this.addToImageQueue(card, imageUrl);
                    }
                  }
                });
              },
              {
                root: null,
                rootMargin: "50px",
                threshold: CONFIG.LAZY_LOAD_THRESHOLD,
              },
      );
    }

    addToImageQueue(card, imageUrl) {
      this.imageLoadQueue.push({ card, imageUrl });

      if (!this.isLoadingImages) {
        this.processImageQueue();
      }
    }

    async processImageQueue() {
      if (this.imageLoadQueue.length === 0) {
        this.isLoadingImages = false;
        return;
      }

      this.isLoadingImages = true;
      const { card, imageUrl } = this.imageLoadQueue.shift();

      try {
        await this.loadImage(imageUrl);
        this.applyImageToCard(card, imageUrl);
      } catch (error) {
        console.error("Ошибка загрузки изображения:", error);
        this.applyFallbackImage(card);
      }

      // Задержка перед загрузкой следующего изображения
      setTimeout(() => {
        this.processImageQueue();
      }, CONFIG.IMAGE_LOAD_DELAY);
    }

    loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    applyImageToCard(card, imageUrl) {
      card.style.backgroundImage = `url('${imageUrl}')`;
      card.classList.add("image-loaded");

      // Добавляем плавную анимацию появления
      card.style.transition = "background-image 0.3s ease-in-out";

      // Перестаем наблюдать за этой карточкой
      this.intersectionObserver.unobserve(card);
    }

    applyFallbackImage(card) {
      card.classList.add("image-loaded", "image-error");
      this.intersectionObserver.unobserve(card);
    }

    renderSkeletonCards() {
      if (!this.eventsContainer) return;

      this.eventsContainer.innerHTML = "";

      for (let i = 0; i < CONFIG.SKELETON_CARDS_COUNT; i++) {
        const skeletonCard = this.createSkeletonCard();
        this.eventsContainer.appendChild(skeletonCard);
      }
    }

    createSkeletonCard() {
      const skeletonCard = document.createElement("div");
      skeletonCard.className = `event-card skeleton-card`;

      skeletonCard.innerHTML = `
      <section class="datetime-section">
        <div class="datetime-header">
          <div>
            <span class="date-text skeleton-text">00 месяца</span>
            <span class="skeleton-text">день недели</span>
          </div>
          <time class="skeleton-text">00:00</time>
        </div>
        <span class="location-text skeleton-text">Место проведения</span>
      </section>
      <div class="title-section">
        <span class="event-title skeleton-text">Название события</span>
        <span class="event-subtitle skeleton-text">Описание события которое может быть достаточно длинным и занимать несколько строк текста</span>
      </div>
      <section class="footer-section">
        <div class="tags-section">
          <div></div>
          <span class="skeleton-text">0+</span>
        </div>
      </section>
    `;

      return skeletonCard;
    }

    async fetchEvents() {
      try {
        const response = await fetch(CONFIG.API_URL);
        const data = await response.json();
        const eventsData = data.response.data.calendars;
        this.events = eventsData.slice(0, this.tracks);
        this.renderEvents();
      } catch (error) {
        this.handleFetchError(error);
      }
    }

    handleFetchError(error) {
      console.error("Ошибка при загрузке событий:", error);
      if (this.eventsContainer) {
        this.eventsContainer.innerHTML = `<div class="error-message">${CONFIG.ERROR_MESSAGE}</div>`;
      }
    }

    formatDate(dateString) {
      const date = new Date(dateString);
      const day = date.getDate();
      const month = MONTHS[date.getMonth()];
      const weekday = WEEKDAYS[date.getDay()];
      return { dateText: `${day} ${month}`, weekday };
    }

    formatTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString("ru-RU", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    formatUrl(dateString, id) {
      const date = new Date(dateString);
      const day = date.getDate();
      const month = date.getMonth();
      const year = date.getFullYear();
      return `//nekrasovka.ru/afisha/${day}-${month}-${year}/${id}`;
    }

    createBackgroundImageUrl(pictureId) {
      return pictureId ? `//nekrasovka.ru/img/${pictureId}/medium` : "none";
    }

    isEventCancelled(event) {
      return event.geo === CONFIG.CANCELLED_EVENT_TEXT;
    }

    createEventCard(event, index) {
      const eventCard = document.createElement("div");
      eventCard.className = `event-card event-card-${index}`;
      return eventCard;
    }

    applyEventCardStyles(eventCard, backgroundImageUrl, isEventCancelled, index) {
      if (isEventCancelled) {
        eventCard.classList.add("error");
        this.addCancelledEventStyles(index, backgroundImageUrl);
      } else {
        // Не устанавливаем фон сразу - это будет делать lazy loading
        eventCard.dataset.imageUrl = backgroundImageUrl;

        // Добавляем карточку в наблюдение
        this.intersectionObserver.observe(eventCard);
      }
    }

    addCancelledEventStyles(index, backgroundImageUrl) {
      const style = document.createElement("style");
      style.textContent = `.event-card-${index}.error::before { background-image: url('${backgroundImageUrl}'); }`;
      document.head.appendChild(style);
    }

    generateLocationSection(event, isEventCancelled) {
      return isEventCancelled
              ? `<span class="location-text">${CONFIG.CANCELLED_EVENT_MESSAGE}</span>`
              : `<a href="${event.geo_link}" target="_blank" class="location-text">${event.geo}</a>`;
    }

    generateEventHTML(event, index) {
      const { dateText, weekday } = this.formatDate(event.date);
      const time = this.formatTime(event.time_start);
      const url = this.formatUrl(event.date, event.id);
      const backgroundImageUrl = this.createBackgroundImageUrl(event.picture_id);
      const isEventCancelled = this.isEventCancelled(event);
      const eventText = event.text.replace(/<[^>]*>/g, "");

      const eventCard = this.createEventCard(event, index);
      this.applyEventCardStyles(
              eventCard,
              backgroundImageUrl,
              isEventCancelled,
              index,
      );

      eventCard.innerHTML = `
      <section class="datetime-section">
        <div class="datetime-header">
          <div>
            <span class="date-text">${dateText}</span>
            <span>${weekday}</span>
          </div>
          <time>${time}</time>
        </div>
        ${this.generateLocationSection(event, isEventCancelled)}
      </section>
      <a href="${url}" class="title-section">
        <span class="event-title">${event.title}</span>
        ${isEventCancelled ? "" : `<span class="event-subtitle">${eventText}</span>`}
      </a>
      <section class="footer-section">
        ${event.price ? '<div class="price-tag">Платное</div>' : ""}
        <div class="tags-section">
          <div></div>
          <span>${event.restriction}</span>
        </div>
      </section>
    `;

      return eventCard;
    }

    renderEvents() {
      if (!this.eventsContainer) return;

      // Очищаем скелетоны
      this.clearSkeletonStyles();
      this.eventsContainer.innerHTML = "";

      // Рендерим реальные события
      this.events.forEach((event, index) => {
        const eventElement = this.generateEventHTML(event, index);
        this.eventsContainer.appendChild(eventElement);
      });

      if (this.windowWidth > CONFIG.DESKTOP_BREAKPOINT) {
        this.updateNavigationButtons();
      }
    }

    clearSkeletonStyles() {
      // Удаляем стили скелетонов
      const skeletonStyles = document.querySelectorAll("style[data-skeleton]");
      skeletonStyles.forEach((style) => style.remove());
    }

    updateNavigationButtons() {
      if (!this.prevButton || !this.nextButton) return;

      this.prevButton.style.display = this.scrollIndex > 1 ? "flex" : "none";
      this.nextButton.style.display =
              this.events.length > CONFIG.ITEMS_PER_PAGE &&
              this.scrollIndex < Math.ceil(this.events.length / CONFIG.ITEMS_PER_PAGE)
                      ? "flex"
                      : "none";
    }

    handleScroll(scrollAmount) {
      if (!this.eventsContainer) return;

      this.eventsContainer.scrollBy({
        left: scrollAmount,
        behavior: "smooth",
      });
    }

    navigateToPrev() {
      this.handleScroll(this.scrollAmount);
      this.scrollIndex++;
      this.updateNavigationButtons();
    }

    navigateToNext() {
      this.handleScroll(-this.scrollAmount);
      this.scrollIndex--;
      this.updateNavigationButtons();
    }

    setupEventListeners() {
      if (!this.prevButton || !this.nextButton) return;

      this.prevButton.addEventListener("click", () => this.navigateToNext());
      this.nextButton.addEventListener("click", () => this.navigateToPrev());
    }

    preventScroll() {
      const container = this.eventsContainer;
      const preventScrollEvent = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      const preventMouseDrag = (e) => {
        e.preventDefault();
      };

      container.addEventListener("wheel", preventScrollEvent, { passive: false });
      container.addEventListener("mousedown", preventMouseDrag);
      container.addEventListener("touchmove", preventScrollEvent, {
        passive: false,
      });
    }

    // Метод для очистки при уничтожении компонента
    destroy() {
      if (this.intersectionObserver) {
        this.intersectionObserver.disconnect();
      }
      this.clearSkeletonStyles();
    }
  }

  function initializeAfisha() {
    const requiredElements = {
      eventsContainer: document.getElementById("eventsContainer"),
      prevButton: document.getElementById("prevButton"),
      nextButton: document.getElementById("nextButton"),
    };

    const allElementsFound = Object.values(requiredElements).every(
            (element) => element,
    );

    if (allElementsFound) {
      console.log("Все элементы найдены - инициализация Afisha");
      new AfishaJS();
    } else {
      console.log("Не все элементы найдены, повторная попытка через 100ms");
      setTimeout(initializeAfisha, CONFIG.RETRY_DELAY);
    }
  }

  // Инициализация при загрузке страницы ИЛИ немедленно, если DOM уже готов
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOMContentLoaded - попытка инициализации Afisha");
      initializeAfisha();
    });
  } else {
    console.log("DOM уже готов - попытка инициализации Afisha");
    initializeAfisha();
  }
</script>
